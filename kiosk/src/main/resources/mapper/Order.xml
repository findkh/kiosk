<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.kiosk.mapper.OrderMapper">
	
	<insert id="create" parameterType="com.kh.kiosk.entity.Order" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tb_order (order_qty, packaging_or_seat, menu_id, order_status, created_dt, updated_dt, call_number)
		VALUES (#{orderQty}, #{packagingOrSeat}, #{menuId}, #{orderStatus}, now(), now(), #{callNumber})
	</insert>
	
	<select id="findOrders" parameterType="map">
		SELECT a.id, a.call_number, a.order_qty, a.packaging_or_seat, a.order_status, a.created_dt, a.updated_dt, b.menu_name as order_menu_name
		FROM tb_order a
		LEFT OUTER JOIN tb_menu b ON b.id::varchar = a.menu_id
		<where>
			<choose>
				<when test='orderStatus == "all"'></when>
				<when test='orderStatus == "w"'>AND a.order_status = 'w'</when>
				<when test='orderStatus == "a"'>AND a.order_status = 'a'</when>
				<otherwise>AND a.order_status != 'c'</otherwise>
			</choose>
			
			<if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				AND a.created_dt >= TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD')
				AND a.created_dt <![CDATA[<=]]> TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD') + INTERVAL '1 day' - INTERVAL '1 second'
			</if>
		</where>
		<choose>
			<when test="startDate != null and startDate != '' and endDate != null and endDate != ''">
				ORDER BY a.created_dt DESC
			</when>
			<otherwise>
				ORDER BY a.created_dt ASC
			</otherwise>
		</choose>
	</select>
	
	<update id="updateOrderStatus" parameterType="map">
		UPDATE tb_order
		SET
			order_status = #{orderStatus},
			updated_dt = now()
		WHERE call_number = #{callNumber}
	</update>
	
	<delete id="delete" parameterType="Integer">
		DELETE 
		FROM tb_order
		WHERE call_number = #{callNumber}
	</delete>
	
</mapper>
